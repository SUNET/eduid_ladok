---
version: "3"

services:
  eduid_ladok:
    container_name: "eduid_ladok_service"
    build:
      context: .
    image: eduid_ladok:latest
    volumes:
      - eduid_ladok:/data
      - ./cert:/cert:ro
      - ./dev-config-docker.yaml:/config.yaml:ro
    depends_on:
      - redis
    networks:
      eduid_ladok-net:
        ipv4_address: 172.16.40.2
    expose:
      - 8080
    environment:
      - "EDUID_CONFIG_YAML=config.yaml"
      - "HTTP_PROXY=haproxy:8080"
      #- "http_proxy=http://proxy.dev.eduid.se:8080"
      #- "HTTPS_PROXY=http://proxy.dev.eduid.se:8080"
      #- "https_proxy=http://proxy.dev.eduid.se:8080"

  dev_docker:
    container_name: "dev_docker"
    build:
      context: ./dev_docker
    image: dev_docker:latest
    networks:
      eduid_ladok-net:
        ipv4_address: 172.16.40.3

  redis:
    image: redis:alpine
    container_name: "eduid_ladok_redis"
    expose:
      - 6379
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      eduid_ladok-net:
        ipv4_address: 172.16.40.4

networks:
  eduid_ladok-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-eduid-ladok
    ipam:
      driver: default
      config:
        - subnet: 172.16.40.0/24
volumes:
  redis_data:
  eduid_ladok:
  haproxy_control:
